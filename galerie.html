<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie | Thomas Soleil</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>

    <nav>
        <a href="index.html" class="logo">Thomas Soleil</a>
        <div class="nav-links">
            <a href="index.html">Albums</a>
            <a href="a-propos.html">À Propos</a>
            <a href="contact.html">Contact</a>
        </div>
    </nav>

    <main>
        <div class="gallery-header">
            <a href="index.html" class="back-link">← Retour aux albums</a>
            <h1 id="album-title">Chargement...</h1>
            <p id="album-meta" style="color: #666; font-style: italic;"></p>
        </div>

        <div class="masonry" id="gallery-container"></div>
    </main>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="">
    </div>

<script src="js/config.js"></script>
<script>
    // --- CONFIGURATION ---
    const BATCH_SIZE = 15; 
    let columnWrappers = []; // Pour stocker nos colonnes

    // 1. Récupération de l'album
    const params = new URLSearchParams(window.location.search);
    const albumId = params.get('id');
    const album = siteConfig.albums.find(a => a.id === albumId);

    if (album) {
        document.title = `${album.title} | Thomas Soleil`;
        document.getElementById('album-title').innerText = album.title;
        document.getElementById('album-meta').innerText = album.date;

        const container = document.getElementById('gallery-container');
        const extension = album.ext || ".webp"; 

        // --- PRÉPARATION DES COLONNES STABLES ---
        container.innerHTML = ""; 
        container.className = "masonry-wrapper";

        // On détermine le nombre de colonnes selon l'écran
        // (3 sur PC, 2 sur Mobile/Tablette)
        const isMobile = window.innerWidth <= 1024;
        const nbColumns = isMobile ? 2 : 3;

        // Création des colonnes HTML
        for (let c = 0; c < nbColumns; c++) {
            let col = document.createElement('div');
            col.className = 'masonry-column';
            container.appendChild(col);
            columnWrappers.push(col);
        }

        // --- MOTEUR DE CHARGEMENT ---
        let currentIndex = 1;

        function loadBatch() {
            const limit = Math.min(currentIndex + BATCH_SIZE, album.count + 1);
            if (currentIndex >= limit) return;

            for (let i = currentIndex; i < limit; i++) {
                
                const div = document.createElement('div');
                div.className = 'photo-item';
                
                const img = document.createElement('img');
                const smallSrc = `${album.folder}/${album.prefix}${i}-small${extension}`;
                const bigSrc = `${album.folder}/${album.prefix}${i}${extension}`;

                img.src = smallSrc;
                img.alt = `${album.title} ${i}`;
                img.loading = "lazy"; 
                
                // Gestion erreur (si pas de miniature, on prend la grande)
                img.onerror = function() { 
                    if (this.src !== bigSrc) this.src = bigSrc; 
                };

                // Apparition douce une fois chargée
                img.onload = () => div.classList.add('visible');

                // Lightbox
                div.onclick = () => {
                    const lightboxImg = document.getElementById('lightbox-img');
                    const lightbox = document.getElementById('lightbox');
                    lightboxImg.src = bigSrc; 
                    lightbox.style.display = 'flex';
                };

                div.appendChild(img);

                // --- ALGORITHME DE DISTRIBUTION ---
                // On ajoute l'image dans la colonne la plus petite pour équilibrer
                // ou simplement tour à tour (plus simple et performant)
                
                // Méthode Tour à Tour (Round Robin) : 
                // Image 1 -> Col 1, Image 2 -> Col 2, Image 3 -> Col 3, Image 4 -> Col 1...
                const colIndex = (i - 1) % nbColumns;
                columnWrappers[colIndex].appendChild(div);
            }

            currentIndex = limit;
        }

        // --- INFINITE SCROLL ---
        loadBatch(); 

        const trigger = document.createElement('div');
        trigger.style.height = "50px"; 
        trigger.style.margin = "20px 0";
        document.querySelector('main').appendChild(trigger);

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                loadBatch();
            }
        }, { rootMargin: "200px" });

        observer.observe(trigger);

    } else {
        document.getElementById('album-title').innerText = "Album introuvable";
    }
</script>
</body>
</html>